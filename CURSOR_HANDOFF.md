# FitFusion â€” Cursor AI Handoff Document

## How to Use This File

**At the start of every Cursor Composer session, paste this prompt:**

> "Read CONTEXT.md and ARCHITECTURE.md in full. Then read the Current Status section of CURSOR_HANDOFF.md. You are now the lead developer on FitFusion. Do not suggest features or structures that contradict these documents. When in doubt, ask. Here is what I need you to do next: [your task]"

That one instruction forces Cursor to load all context before generating a single character of code. Do not skip it.

---

## Project Identity

- **Project:** FitFusion
- **Type:** Android mobile application â€” fitness game with AR overlay
- **Bundle ID:** `com.wukinnin428.fitfusion`
- **Repository:** `https://github.com/wukinnin/fitfusion`
- **Platform:** Flutter (Dart), Android only, target device is Tecno Spark Go 30c (Android 14, budget hardware)
- **Editor:** Cursor AI on Fedora Linux 43, ThinkPad T470

---

## What FitFusion Is (30-Second Summary for Cursor)

FitFusion is a game where you exercise to play. The phone's camera detects your body movements using Google ML Kit Pose Detection. The game renders as a 2D overlay on top of the camera feed â€” the "AR" effect. You choose one of three exercises (Squats, Jumping Jacks, Side Oblique Crunches) before a session. Completing reps attacks a monster on screen. Stopping for more than 3 seconds lets the monster attack you (you lose a life). Survive 10 rounds to win. Google Sign-In via Firebase saves your scores to a leaderboard. High fantasy aesthetic â€” bright colors, sprites, gold UI.

This is an academic Capstone Project with a hard one-month deadline. **Ship the MVP. That's the only goal.**

---

## Complete Tech Stack

| Layer | Tool | Notes |
|-------|------|-------|
| App framework | Flutter (Dart) | Android target only |
| Game engine | Flame `^1.18.0` | 2D, runs inside Flutter |
| Motion input | `google_mlkit_pose_detection ^0.11.0` | On-device, base model |
| Camera | `camera ^0.11.0` | Frame streaming to ML Kit |
| Auth | Firebase Auth + `google_sign_in ^6.2.1` | Google Sign-In only |
| Database | Cloud Firestore | Singapore region |
| Backend bridge | FlutterFire | Config already done |
| State management | `provider ^6.1.2` | Minimal usage |
| Permissions | `permission_handler ^11.3.0` | Camera runtime request |
| Typography | `google_fonts ^6.2.1` | Cinzel for fantasy look |
| Editor | Cursor AI (VS Code fork) | Composer = primary tool |
| Version control | Git + GitHub | `wukinnin/fitfusion` |
| Host OS | Fedora Linux 43 | ThinkPad T470, i5-6300U, 16GB |
| Java | OpenJDK 21 | Required for Gradle |
| Gradle | 8 | Android build system |
| Android SDK | API 35 / build-tools 35.0.0 | Command-line tools only |
| ADB | Via Android SDK platform-tools | Device: Tecno Spark Go 30c |

---

## Development Environment Facts (All Verified Working)

- Flutter SDK is at `~/development/flutter`, on `$PATH`
- Android SDK is at `~/development/android-sdk`, `$ANDROID_HOME` set, on `$PATH`
- `flutter doctor` passes on Flutter + Android toolchain
- Device connected via ADB (Tecno Spark Go 30c, Android 14)
- `flutter run` successfully deploys to the device (default counter app confirmed)
- Firebase project configured, `firebase_options.dart` exists at `lib/firebase_options.dart`
- `google-services.json` exists at `android/app/google-services.json`
- Firebase Auth: Google Sign-In enabled, debug SHA-1 fingerprint registered
- Firestore: database created, test mode, Singapore region (`asia-southeast1`)
- Git initialized, main branch, remote at `github.com/wukinnin/fitfusion`

**Nothing in the dev environment needs to be set up. Start writing code.**

---

## Current Project State

> **UPDATE THIS SECTION AFTER EVERY SIGNIFICANT CODING SESSION.**
> Keep it accurate. An outdated status section is worse than no status section.

### As of: Initial Handoff (Day 0)

**What exists:**
- Flutter scaffold (`flutter create fitfusion --org com.wukinnin428 --platforms android`)
- `pubspec.yaml` with all dependencies added and resolved
- `firebase_options.dart` generated by FlutterFire
- `google-services.json` in `android/app/`
- `AndroidManifest.xml` with camera and internet permissions added
- `hardwareAccelerated="true"` set on application tag
- Default `lib/main.dart` (Flutter counter app â€” not yet replaced)
- Git: 2 commits on `main` branch

**What does NOT exist yet:**
- Nothing under `lib/` except `main.dart` and `firebase_options.dart`
- No feature code whatsoever
- No `lib/core/` directory
- No `lib/features/` directory
- No `lib/widgets/` directory
- No `assets/` content (sprites, audio, fonts)

**The app currently runs the default Flutter counter app on the Tecno Spark Go 30c.**

---

## Milestone Map

Work through these in strict order. Do not start the next milestone until the current one is working and tested on the physical device.

### âœ… Milestone 0 â€” Environment Setup
**Status: COMPLETE**
Dev environment set up, Firebase configured, app deploys to device.

---

### ðŸ”² Milestone 1 â€” Camera Feed + Pose Detection
**Status: NOT STARTED**
**Target: Days 1â€“4**

**Deliverable:** Open the app, see yourself in the camera feed. ML Kit detects your pose. A skeleton overlay of dots/lines is drawn on your body in real time. The rep counter for all three exercises correctly detects and counts reps.

**Tasks in order:**
1. Replace `main.dart` and `app.dart` with real app skeleton â€” initialize Firebase, set up routing, wrap in providers
2. Create `lib/core/constants.dart` â€” all game constants defined
3. Create `lib/core/enums.dart` â€” `WorkoutType`, `GamePhase`, etc.
4. Create `lib/core/theme.dart` â€” app theme, colors, fonts (Cinzel), button styles
5. Create `lib/features/motion/camera_service.dart` â€” CameraController, front camera, low resolution, frame streaming with skip
6. Create `lib/features/motion/pose_detector_service.dart` â€” ML Kit wrapper, CameraImage â†’ InputImage conversion, Stream<Pose?>
7. Create `lib/widgets/camera_preview_widget.dart` â€” fills screen with camera feed
8. Create `lib/widgets/pose_overlay_painter.dart` â€” CustomPainter drawing 33 landmark dots for debug
9. Create a basic `GameScreen` stub that shows camera feed + pose overlay â€” deploy to device and verify pose detection is working
10. Create `lib/features/motion/rep_detector.dart` â€” state machines for Squats, Jumping Jacks, Side Oblique Crunches with rolling average filter
11. Create `lib/features/motion/pace_monitor.dart` â€” pace timer, Stream<PaceEvent>
12. Test all three exercises on the physical device with console output confirming rep counts

**Done when:** You can do squats, jumping jacks, and crunches in front of the phone and see correct rep counts printing in the debug console.

---

### ðŸ”² Milestone 2 â€” Core Game Loop
**Status: NOT STARTED**
**Target: Days 5â€“12**

**Deliverable:** A fully playable 10-round game session on the device. Camera feed visible, game elements overlaid, reps hit the monster, pace mechanic works, lives system works, win/lose screens appear.

**Tasks in order:**
1. Create `lib/features/game/fitfusion_game.dart` â€” FlameGame subclass, transparent background, game state machine
2. Create all Flame components: `MonsterComponent`, `MonsterHealthBar`, `PlayerLivesDisplay`, `RoundBanner`, `RepProgressBar`, `DamageNumber`, `CooldownOverlay`, `PaceTimerIndicator`
3. Create `lib/features/game/game_controller.dart` â€” bridge between motion pipeline and FitFusionGame
4. Create `lib/features/game/game_session.dart` â€” immutable session result data class
5. Build `GameScreen` â€” Stack with CameraPreviewWidget, PoseOverlayPainter (debug), GameWidget
6. Build `WorkoutSelectScreen` â€” three options, routes to GameScreen with workout type
7. Build `ResultsScreen` â€” shows win/lose, reps, time
8. Build `HomeScreen` â€” Play button â†’ WorkoutSelectScreen
9. Wire up navigation in `app.dart`
10. End-to-end test: select workout â†’ play all 10 rounds â†’ see results

**Done when:** You can complete a full 10-round game session on the Tecno. All mechanics (reps, pace, lives, cooldown, win/lose) behave correctly.

---

### ðŸ”² Milestone 3 â€” Firebase Integration
**Status: NOT STARTED**
**Target: Days 13â€“18**

**Deliverable:** Google Sign-In works on the device. After a session, data writes to Firestore. Leaderboard shows real data. Stats screen shows real data.

**Tasks in order:**
1. Create `lib/features/auth/auth_service.dart` â€” Google Sign-In, sign-out, user creation
2. Create `lib/features/auth/auth_provider.dart` â€” ChangeNotifier exposing auth state to widgets
3. Create `lib/features/firebase/firestore_service.dart` â€” all Firestore reads/writes
4. Create `lib/features/firebase/leaderboard_service.dart`
5. Create `lib/features/firebase/stats_service.dart`
6. Wire `ResultsScreen` to call Firebase writes on session end (if signed in)
7. Build `LeaderboardScreen` â€” tabbed by workout type, shows Top 10
8. Build `StatsScreen` â€” personal stats per workout
9. Add Sign In / Sign Out to `HomeScreen`
10. Test: sign in â†’ play a session â†’ check Firestore console for written data

**Done when:** Sign-in works. After a session, data appears in the Firestore console. Leaderboard and stats screens display real data.

---

### ðŸ”² Milestone 4 â€” Visual Polish
**Status: NOT STARTED**
**Target: Days 18â€“24**

**Deliverable:** The app looks like a real high-fantasy game, not a prototype.

**Tasks:**
1. Source free monster sprite assets from itch.io or OpenGameArt.org (10 monster types or 5 with variants)
2. Integrate sprites into `MonsterComponent` with idle + hit animation
3. Apply `AppTheme` throughout all screens (Cinzel font, gold+navy palette)
4. Add `fantasy_button.dart` and use it everywhere
5. Add floating damage number animations to `DamageNumber` component
6. Style health bars, HUD elements, lives hearts with fantasy aesthetic
7. Add sound effects using Flame's audio: rep hit, monster death, round start, game over
8. Style `ResultsScreen` with victory/defeat banners
9. Remove pose skeleton overlay from production build (keep behind `kDebugMode` flag)
10. Test all screens for visual consistency

**Done when:** The app looks presentable for a demo and academic defense.

---

### ðŸ”² Milestone 5 â€” Testing and Submission
**Status: NOT STARTED**
**Target: Days 25â€“30**

**Deliverable:** A release APK that works reliably for a demo.

**Tasks:**
1. Test all three exercise types end-to-end on the Tecno
2. Test in a well-lit environment and document the lighting requirement
3. Test Google Sign-In and all Firebase flows
4. Fix any crashes found during testing
5. Set proper Firestore security rules (replace test mode rules)
6. Generate release keystore and update `android/app/build.gradle` with signing config
7. Register release SHA-1 in Firebase Console
8. Build release APK: `flutter build apk --release`
9. Install release APK on Tecno and do final smoke test
10. Tag the release commit on GitHub: `git tag v1.0.0-mvp`

**Done when:** Release APK installs and runs demo-correctly on the Tecno Spark Go 30c.

---

## Rules for Cursor When Writing Code

These apply to every file, every session, without exception:

1. **Read CONTEXT.md and ARCHITECTURE.md first.** Every session. No exceptions.

2. **The target device is a budget Android phone.** Optimize for it. No exceptions.

3. **Process camera frames off the main thread.** Use `compute()` for ML Kit inference. Never block the UI thread.

4. **Skip frames.** Never send every camera frame to ML Kit. Use `kFrameSkipCount`.

5. **Check landmark likelihood.** Never use a landmark with `likelihood < kLandmarkLikelihoodThreshold`. Discard unreliable frames.

6. **No magic numbers.** Every game parameter goes in `lib/core/constants.dart`. Use the constant name in code, not the raw value.

7. **No logic in widget files.** Widgets display state. State lives in services, controllers, and notifiers.

8. **The Flame game does not import Firebase.** If you find yourself importing a Firebase package in `fitfusion_game.dart` or any component under `lib/features/game/components/`, stop and refactor.

9. **The rep detector does not import Flame.** Same principle. Layers are independent.

10. **All Firebase calls are in try/catch.** Firebase must never crash the game.

11. **Test on the physical device, not the emulator.** Camera and ML Kit behave differently on real hardware. Always deploy to the Tecno during Milestone 1 and 2 work.

12. **Commit when something works.** Don't let working code exist only locally. `git add . && git commit -m "..."` after each meaningful step.

13. **Don't implement out-of-scope features.** If it's not in CONTEXT.md, it doesn't exist. No multiplayer, no 3D, no personalization, no extra modes.

14. **Prefer simple over clever.** This is a month-long project under deadline. Readable, working code beats elegant architecture every time.

---

## File Creation Checklist for Milestone 1

Use this as a literal task list in your first Cursor session. Check them off as each file is created and confirmed working:

```
lib/
  [ ] main.dart                         â€” replace default counter app
  [ ] app.dart                          â€” MaterialApp, theme, routes
  [ ] firebase_options.dart             â€” already exists, do not touch
  [ ] core/
      [ ] constants.dart
      [ ] enums.dart
      [ ] theme.dart
      [ ] extensions.dart
  [ ] features/
      [ ] motion/
          [ ] camera_service.dart
          [ ] pose_detector_service.dart
          [ ] rep_detector.dart
          [ ] pace_monitor.dart
      [ ] screens/
          [ ] splash_screen.dart        â€” minimal stub, just routes to home
          [ ] home_screen.dart          â€” minimal stub, just a Play button
          [ ] game_screen.dart          â€” camera + pose overlay, no Flame yet
  [ ] widgets/
      [ ] camera_preview_widget.dart
      [ ] pose_overlay_painter.dart
```

---

## Useful Commands

```bash
# Run on device
flutter run

# Run with verbose output (use when debugging camera/ML Kit issues)
flutter run -v

# Hot reload (press while flutter run is active)
r

# Hot restart (press while flutter run is active)
R

# Check connected device
flutter devices

# Check ADB
adb devices

# Reconnect wireless ADB (after phone reboot)
adb tcpip 5555
adb connect <phone-ip>:5555

# Clean build (use when weird build errors appear)
flutter clean && flutter pub get

# Build release APK (Milestone 5 only)
flutter build apk --release

# View device logs
adb logcat | grep flutter

# Commit and push
git add .
git commit -m "your message here"
git push
```

---

## Common Issues and Fixes

**"CameraImage conversion to InputImage fails" or "ML Kit returns no landmarks"**
â†’ The byte format conversion is the most common failure point. Verify `InputImageFormat.yuv420` matches the format reported by `CameraImage.format.group`. On some Android devices this is `ImageFormatGroup.yuv420`, on others it may differ. Add a log statement to print `image.format.group` and verify.

**"Rep detection fires too easily / phantom reps"**
â†’ Rolling average window is too small, or threshold is too permissive. Increase window size from 5 to 7 frames. Tighten the threshold constant. Test with deliberate slow movements to find the boundary.

**"Rep detection doesn't fire at all / misses real reps"**
â†’ Threshold is too strict. Check landmark likelihood â€” if you're filtering too aggressively, most frames get discarded. Lower `kLandmarkLikelihoodThreshold` from 0.5 to 0.4 as a test.

**"Camera preview is black or frozen"**
â†’ `hardwareAccelerated="true"` missing from AndroidManifest. Or `CameraController` was not initialized before `CameraPreview` widget was built. Use `FutureBuilder` to wait for `_cameraController.initialize()`.

**"Flame game covers the camera feed"**
â†’ `FitFusionGame` background is not transparent. Add `backgroundColor: Colors.transparent` to the `FlameGame` constructor or override `backgroundColor()`.

**"Gradle sync takes forever or fails"**
â†’ First sync downloads ~200â€“400MB. Run `flutter run -v` and wait. If it fails with a network error, run again. Do not run `flutter clean` unnecessarily â€” it forces a full re-sync.

**"adb device not found after phone reboot"**
â†’ Wireless ADB connection is lost on reboot. Reconnect: `adb tcpip 5555 && adb connect <phone-ip>:5555`

**"Google Sign-In fails with 'developer error'"**
â†’ SHA-1 fingerprint is not registered in Firebase Console, or the wrong fingerprint was added. Run `cd android && ./gradlew signingReport` and copy the debug SHA-1. Register it at Firebase Console â†’ Project Settings â†’ Your Apps â†’ Android App â†’ Add Fingerprint.

---

## Session Start Template

Copy and paste this into Cursor Composer at the start of every work session:

```
Please read the following files in this project in full before responding:
1. CONTEXT.md
2. ARCHITECTURE.md
3. CURSOR_HANDOFF.md (the Current Status section)

Once you have read them, confirm you understand the project by summarizing in 3 sentences:
- What FitFusion is
- What the current project state is
- What milestone we are working on

Then I will give you the specific task.
```

After Cursor confirms, give it the specific task for that session. This 30-second ritual prevents 90% of the "Cursor going off in the wrong direction" problems.
